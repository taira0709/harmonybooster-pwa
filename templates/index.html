<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ハーモニーブースター</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" type="image/png" href="/static/icon.png">
<link rel="apple-touch-icon" href="/static/icon-512.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00BFFF">

<link rel="stylesheet" href="/static/style.css">

<script>
  // 本番のみSWを登録。URLは /sw.js に統一し、?v= でバージョン更新
  if ('serviceWorker' in navigator && !['localhost', '127.0.0.1'].includes(location.hostname)) {
    navigator.serviceWorker.register('/sw.js?v=hb-v6').catch(()=>{});
  }
</script>

<style>
  body { font-family: system-ui, sans-serif; padding: 1em; background:#121212; color:#fff; }
  .container { max-width: 800px; margin: auto; background:#1e1e1e; padding:2em; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,.4); }
  h1 { margin-bottom:.5em; }
  .logo-text{font-size:3.2em;font-weight:bold;text-align:left;color:#00BFFF;text-shadow:0 0 5px #00BFFF,0 0 10px #00BFFF,0 0 20px #008CBA,0 0 40px #008CBA;letter-spacing:.05em;margin:.5em 0;position:relative}
  .logo-text::after{content:"";display:block;width:100%;max-width:12em;height:4px;margin-top:.3em;background:linear-gradient(90deg,#00BFFF,#008CBA);border-radius:2px;box-shadow:0 0 10px #00BFFF,0 0 20px #008CBA}
  label{display:block;margin-top:1.5em;color:#ccc;font-weight:500}
  input[type="range"],input[type="number"],select{width:100%;padding:.5em;border-radius:6px;border:none;background:#2a2a2a;color:#fff;font-size:1em}
  input[type="range"]{accent-color:#00BFFF;padding:0;margin:0;box-sizing:border-box;width:100%;background:linear-gradient(to right,#00BFFF 0%,#00BFFF var(--val),#2a2a2a var(--val),#2a2a2a 100%)}
  .range-val{font-weight:bold;margin-left:.5em;color:#00BFFF}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  button{margin-top:2em;padding:1em 2em;background:#00BFFF;color:#fff;border:none;border-radius:8px;font-size:1em;cursor:pointer;transition:.2s}
  button:hover{background:#008CBA}
  audio{width:100%;margin-top:1em}
  input[type="file"]{background:#2a2a2a;color:#fff;border:none;padding:.5em;border-radius:6px}
  input[type="file"]::file-selector-button{background:#00BFFF;color:#fff;border:none;border-radius:6px;padding:.4em .8em;cursor:pointer;transition:.2s}
  input[type="file"]::file-selector-button:hover{background:#008CBA}
  .inline{display:flex;align-items:center;gap:.3em}
  .reset-btn{padding:.1em .4em;font-size:.7em;line-height:1;height:1.6em;background:#00BFFF;color:#fff;border:none;border-radius:3px;cursor:pointer;margin-top:0}
  .reset-btn:hover{background:#008CBA;border:none;color:#fff}

/* === spinner === */
#spinner { display:none; text-align:center; margin-top:1em; }
.loader {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #00BFFF;
  border-radius: 50%;
  width: 40px; height: 40px;
  animation: spin 1s linear infinite;
  margin: 12px auto;
}
@keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
</style>
</head>
<body>
<div class="container">
  <h1 class="logo-text">Harmony Booster</h1>
  <p>① 音声ファイルを選び、② プリセットまたはスライダーを調整し、③ 書き出しでWAVをダウンロードできます。</p>

  <form id="hb-form" method="post" enctype="multipart/form-data" onsubmit="return false;">
    <label>① 音声ファイルをアップロード
      <input type="file" name="file" accept="audio/*" required>
    </label>

    <label>② プリセット選択
      <select id="preset_id" name="preset_id">
        <option value="male">男性</option>
        <option value="female">女性</option>
        <option value="custom">カスタム</option>
      </select>
    </label>

    <div class="grid">
      <div>
        <label>帯域 Low (Hz)
          <input type="number" id="band_low" name="band_low" value="200" min="50" max="12000" step="10">
        </label>
        <label>帯域 High (Hz)
          <input type="number" id="band_high" name="band_high" value="6000" min="200" max="20000" step="10">
        </label>

        <label>ミッドゲイン
          <div class="inline">
            <input type="range" id="mid_atten_db" name="mid_atten_db" min="-80" max="6" step="0.5" value="0">
            <span id="mid_val" class="range-val"></span>
            <button type="button" class="reset-btn" title="リセット" onclick="resetSlider('mid_atten_db', 0)">R</button>
          </div>
        </label>

        <label>サイドゲイン
          <div class="inline">
            <input type="range" id="side_gain_db" name="side_gain_db" min="-12" max="12" step="0.5" value="0">
            <span id="side_val" class="range-val"></span>
            <button type="button" class="reset-btn" title="リセット" onclick="resetSlider('side_gain_db', 0)">R</button>
          </div>
        </label>

        <label>出力ゲイン
          <div class="inline">
            <input type="range" id="output_gain_db" name="output_gain_db" min="-12" max="12" step="0.5" value="0">
            <span id="out_val" class="range-val"></span>
            <button type="button" class="reset-btn" title="リセット" onclick="resetSlider('output_gain_db', 0)">R</button>
          </div>
        </label>
      </div>

      <div>
        <label>低域保護 (Hz)
          <input type="number" id="protect_low_hz" name="protect_low_hz" value="120" min="20" max="400" step="10">
        </label>
        <label>高域保護 (Hz)
          <input type="number" id="protect_high_hz" name="protect_high_hz" value="8000" min="4000" max="20000" step="100">
        </label>
        <label>②のプリセットを「男性／女性」にすると帯域Low/Highは自動設定され編集不可になります。</label>
      </div>
    </div>

    <label>③ プレビュー（WebAudio）
      <audio id="audio" controls></audio>
    </label>

    <button id="download-btn" type="submit">高品質で処理してダウンロード</button>
  
<!-- 処理中インジケータ -->
<div id="spinner">
  <div class="loader"></div>
  <p>処理中です。しばらくお待ちください…</p>
</div>

</form>
</div>

<script>
;(function() {
  const audio = document.getElementById("audio");
  const fileInput = document.querySelector("input[type='file']");
  const sliders = {
    band_low: document.getElementById("band_low"),
    band_high: document.getElementById("band_high"),
    mid_atten_db: document.getElementById("mid_atten_db"),
    side_gain_db: document.getElementById("side_gain_db"),
    output_gain_db: document.getElementById("output_gain_db"),
    protect_low_hz: document.getElementById("protect_low_hz"),
    protect_high_hz: document.getElementById("protect_high_hz")
  };

  const dB2gain = db => Math.pow(10, db / 20);
  let ctx, srcNode, nodeSetup = false;
  let update = null;

  function initAudioGraph() {
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    srcNode = ctx.createMediaElementSource(audio);
    const splitter = ctx.createChannelSplitter(2);
    srcNode.connect(splitter);
    const gLtoM = ctx.createGain(); gLtoM.gain.value = 0.5;
    const gRtoM = ctx.createGain(); gRtoM.gain.value = 0.5;
    const gLtoS = ctx.createGain(); gLtoS.gain.value = 0.5;
    const gRtoS = ctx.createGain(); gRtoS.gain.value = -0.5;
    splitter.connect(gLtoM, 0); splitter.connect(gRtoM, 1);
    splitter.connect(gLtoS, 0); splitter.connect(gRtoS, 1);
    const mSum = ctx.createGain();
    const sSum = ctx.createGain();
    gLtoM.connect(mSum); gRtoM.connect(mSum);
    gLtoS.connect(sSum); gRtoS.connect(sSum);
    const hpBand = ctx.createBiquadFilter(); hpBand.type = "highpass"; hpBand.Q.value = 0.707;
    const lpBand = ctx.createBiquadFilter(); lpBand.type = "lowpass";  lpBand.Q.value = 0.707;
    mSum.connect(hpBand); hpBand.connect(lpBand);
    const bandScale = ctx.createGain();
    const bandInvert = ctx.createGain(); bandInvert.gain.value = -1;
    lpBand.connect(bandScale); bandScale.connect(bandInvert);
    const midBus = ctx.createGain();
    mSum.connect(midBus);
    bandInvert.connect(midBus);
    const sGain = ctx.createGain();
    sSum.connect(sGain);
    const mToL = ctx.createGain();
    const mToR = ctx.createGain();
    const sToL = ctx.createGain(); sToL.gain.value = 1;
    const sToR = ctx.createGain(); sToR.gain.value = -1;
    midBus.connect(mToL);  midBus.connect(mToR);
    sGain.connect(sToL);   sGain.connect(sToR);
    const sumL = ctx.createGain();
    const sumR = ctx.createGain();
    mToL.connect(sumL); sToL.connect(sumL);
    mToR.connect(sumR); sToR.connect(sumR);
    const merger = ctx.createChannelMerger(2);
    sumL.connect(merger, 0, 0);
    sumR.connect(merger, 0, 1);
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -6; comp.knee.value = 6;
    comp.ratio.value = 3; comp.attack.value = 0.003; comp.release.value = 0.25;
    const hpProtect = ctx.createBiquadFilter(); hpProtect.type = "highpass"; hpProtect.Q.value = 0.707;
    const lpProtect = ctx.createBiquadFilter(); lpProtect.type = "lowpass";  lpProtect.Q.value = 0.707;
    const outGain = ctx.createGain();
    merger.connect(comp);
    comp.connect(hpProtect);
    hpProtect.connect(lpProtect);
    lpProtect.connect(outGain);
    outGain.connect(ctx.destination);

    update = function() {
      const bl = parseFloat(sliders.band_low.value);
      const bh = parseFloat(sliders.band_high.value);
      const pl = parseFloat(sliders.protect_low_hz.value);
      const ph = parseFloat(sliders.protect_high_hz.value);
      const md = parseFloat(sliders.mid_atten_db.value);
      const sd = parseFloat(sliders.side_gain_db.value);
      const od = parseFloat(sliders.output_gain_db.value);
      hpBand.frequency.setTargetAtTime(Math.max(20, bl), ctx.currentTime, 0.02);
      lpBand.frequency.setTargetAtTime(Math.max(bh, bl+1), ctx.currentTime, 0.02);
      const gMid = dB2gain(md);
      const k = (md <= -75) ? 1.25 : (md <= -60 ? 1.15 : 1.0);
      bandScale.gain.setTargetAtTime(k * (1 - gMid), ctx.currentTime, 0.02);
      const gs = dB2gain(sd);
      sGain.gain.setTargetAtTime(gs, ctx.currentTime, 0.02);
      const mNorm = 1 / Math.sqrt(1 + gs * gs);
      mToL.gain.setTargetAtTime(mNorm, ctx.currentTime, 0.02);
      mToR.gain.setTargetAtTime(mNorm, ctx.currentTime, 0.02);
      hpProtect.frequency.setTargetAtTime(pl, ctx.currentTime, 0.02);
      lpProtect.frequency.setTargetAtTime(ph, ctx.currentTime, 0.02);
      const safety = 1 / Math.max(1, gs * 0.6);
      outGain.gain.setTargetAtTime(safety * dB2gain(od), ctx.currentTime, 0.02);
    };

    let rafId = null;
    function scheduleUpdate(){
      if (rafId !== null) return;
      rafId = requestAnimationFrame(() => { rafId = null; if (typeof update === "function") update(); });
    }
    Object.values(sliders).forEach(el => {
      el.addEventListener("input", scheduleUpdate, {passive:true});
      el.addEventListener("change", scheduleUpdate);
    });

    update();
    nodeSetup = true;
    window.applyIfReady = () => { if (nodeSetup && typeof update === "function") update(); };
  }

  fileInput.addEventListener("change", (evt) => {
    const file = evt.target.files[0];
    if (file) {
      audio.autoplay = false;
      audio.muted = false;
      audio.src = URL.createObjectURL(file);
      audio.load();
      audio.pause();
      audio.currentTime = 0;
    }
  });

  audio.addEventListener("play", () => {
    if (!nodeSetup) initAudioGraph();
    if (ctx && ctx.state !== "running") ctx.resume();
  }, { passive: true });

  ["click","touchstart","keydown"].forEach(ev => {
    document.addEventListener(ev, () => {
      if (!nodeSetup) initAudioGraph();
      if (ctx && ctx.state !== "running") ctx.resume();
    }, { once: true, passive: true });
  });
})();
</script>

<script>
  // Rボタン
  window.resetSlider = function(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = value;
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
    if (window.applyIfReady) window.applyIfReady();
  };

  // スライダー色塗り
  document.querySelectorAll('input[type="range"]').forEach(slider => {
    const update = () => {
      const val = (slider.value - slider.min) / (slider.max - slider.min) * 100;
      slider.style.setProperty('--val', val + '%');
    };
    slider.addEventListener('input', update);
    update();
  });
</script>

<!-- DL進捗バー＋トースト -->
<script>
function toast(msg){
  let t = document.getElementById('hb-toast');
  if(!t){
    t = document.createElement('div'); t.id='hb-toast';
    t.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);'+
      'background:#00BFFF;color:#fff;padding:10px 16px;border-radius:8px;'+
      'box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:9999;transition:.25s';
    document.body.appendChild(t);
  }
  t.textContent = msg; t.style.opacity='1';
  setTimeout(()=> t.style.opacity='0', 2200);
}
function ensureProgress(){
  let wrap = document.getElementById('hb-prog');
  if(!wrap){
    wrap = document.createElement('div'); wrap.id='hb-prog';
    wrap.innerHTML = '<div style="height:6px;background:#333;border-radius:4px;overflow:hidden">'+
                     '  <span id="hb-prog-fill" style="display:block;height:6px;width:0%;background:#00BFFF"></span>'+
                     '</div>';
    wrap.style.cssText='position:fixed;left:24px;right:24px;bottom:64px;z-index:9999';
    document.body.appendChild(wrap);
  }
  return document.getElementById('hb-prog-fill');
}
function setProgress(pct){
  const fill = ensureProgress();
  fill.style.width = Math.max(0, Math.min(100, pct)) + '%';
  if (pct >= 100) setTimeout(()=> document.getElementById('hb-prog')?.remove(), 800);
}
</script>

<!-- APIへPOSTしてWAVをダウンロード（進捗＋完了表示つき） -->
<script>
const API_BASE = '/api';

document.getElementById('hb-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const file = document.querySelector('input[name="file"]').files[0];
  if (!file) { toast('音声ファイルを選択してください'); return; }

  const fd = new FormData(e.target);

  document.getElementById('spinner').style.display = 'block';

  try {
    toast('サーバーで処理中…');
    const res = await fetch(`${API_BASE}/process`, {
      method: 'POST',
      body: fd,
      cache: 'no-store',
      credentials: 'same-origin', 
    });

    const ct = res.headers.get('content-type') || '';

    // エラー系（JSONで返る想定）
    if (!res.ok) {
      let reason = '';
      if (ct.includes('application/json')) {
        try { const j = await res.json(); reason = j.error || ''; } catch {}
      } else {
        try { reason = await res.text(); } catch {}
      }
      throw new Error(reason || `API error ${res.status}`);
    }

    // 成功系（WAVバイナリ）
    if (ct.includes('application/json')) {
      // 想定外：成功でJSONが来た場合
      const j = await res.json().catch(()=> ({}));
      toast(j.message || '処理は完了しましたが、ダウンロードデータが見つかりません');
      return;
    }

    const total = Number(res.headers.get('Content-Length') || 0);
    const reader = res.body?.getReader?.();
    let chunks = [], received = 0;

    if (reader) {
      setProgress(0);
      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
        if (total > 0) setProgress(Math.floor((received/total)*100));
      }
      const blob = new Blob(chunks, {type: 'audio/wav'});
      setProgress(100);
      downloadBlob(blob, 'HarmonyBooster_out.wav');
      toast('ダウンロード完了！');
    } else {
      const blob = await res.blob();
      downloadBlob(blob, 'HarmonyBooster_out.wav');
      toast('ダウンロード開始しました');
    }

  } catch (err) {
    console.error(err);
    toast('処理に失敗しました: ' + (err?.message || '不明なエラー'));
    document.getElementById('hb-prog')?.remove();
  } finally {
    document.getElementById('spinner').style.display = 'none';
  }
});

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>

<script>
  const presetEl = document.getElementById("preset_id");
  const bandLow = document.getElementById("band_low");
  const bandHigh = document.getElementById("band_high");
  function updatePreset() {
    const preset = presetEl.value;
    if (preset === "male") {
      bandLow.value = 120; bandHigh.value = 4000; bandLow.disabled = true; bandHigh.disabled = true;
    } else if (preset === "female") {
      bandLow.value = 200; bandHigh.value = 6000; bandLow.disabled = true; bandHigh.disabled = true;
    } else { bandLow.disabled = false; bandHigh.disabled = false; }
    if (window.applyIfReady) window.applyIfReady();
  }
  presetEl.addEventListener("change", updatePreset);
  updatePreset();
</script>


<script>
window.addEventListener('load', ()=>{
  const sp = document.getElementById('spinner'); if (sp) sp.style.display='none';
});
</script>

</body>
</html>
